{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å {{ chat_info.name if chat_info else '...' }}{% endblock %}

{% block content %}

<div class="content-card"> 
    <h1>–ß–∞—Ç —Å {{ chat_info.name if chat_info else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —á–∞—Ç' }}</h1>
    <p class="chat-id-display"><small>ID —á–∞—Ç–∞: {{ chat_id }}</small></p>

    {% if history_error %}
        <div class="alert alert-error">{{ history_error }}</div>
    {% endif %}

    <div class="update-history-form">
        <form method="get" action="{{ url_for('chat_page', chat_id=chat_id) }}">
             <label for="num_messages_to_load">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π:</label>
             <input type="number" name="limit" id="num_messages_to_load" value="{{ current_limit }}" min="1" max="500">
             <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>
    </div>

    <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ({{ '–ü–æ—Å–ª–µ–¥–Ω–∏–µ ' ~ history | length if history else '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π' }})</h2>
    <div class="chat-history">
        {% if history %}
            {% for msg in history %}
                <div class="message {{ msg.role }}">
                    {% for part in msg.parts %}
                        {% if part.text %}
                            <pre>{{ part.text }}</pre>
                        {% endif %}
                        
                        {% if part.image_base64 %}
                            <img src="data:{{ part.mime_type }};base64,{{ part.image_base64 }}"
                                alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞"
                                style="max-width: 100%; border-radius: 12px; margin-top: 8px;">
                        
                        {% elif part.video_base64 and part.mime_type == 'video/mp4' %}
                            <video controls loop autoplay muted
                                style="max-width: 100%; border-radius: 12px; margin-top: 8px;">
                                <source src="data:{{ part.mime_type }};base64,{{ part.video_base64 }}" type="{{ part.mime_type }}">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—ç–≥ video.
                            </video>
                        
                        {% elif part.audio_base64 and part.mime_type in ['audio/mpeg', 'audio/ogg'] %}
                             <audio controls>
                                 <source src="data:{{ part.mime_type }};base64,{{ part.audio_base64 }}" type="{{ part.mime_type }}">
                                 –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç.
                             </audio>

                        {% elif part.file_base64 and part.mime_type == 'application/pdf' %}
                             <a href="data:{{ part.mime_type }};base64,{{ part.file_base64 }}" target="_blank" class="pdf-attachment">
                                 <span class="pdf-icon">üìÑ</span>
                                 <div class="pdf-info">
                                     <strong>PDF –î–æ–∫—É–º–µ–Ω—Ç</strong>
                                     <small>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</small>
                                 </div>
                             </a>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            {% if not history_error %}
            <p style="text-align: center; color: var(--secondary-color); padding: 20px;">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç–∞.</p>
            {% endif %}
        {% endif %}
    </div>
</div>


<div class="content-card">
    <div class="generation-header">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º</h2>
    </div>

    {% if generation_error %}
        <div class="alert alert-error">{{ generation_error }}</div>
    {% endif %}

    <div>
<div class="character-management-section">
            <h4>1. –í—ã–±–æ—Ä –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h4>
            <div class="character-management">
                <div class="character-selector">
                    <form action="{{ url_for('set_active_character', chat_id=chat_id) }}" method="POST" id="character-select-form">
                        <label for="character_id">–ê–∫—Ç–∏–≤–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂:</label>
                        <select name="character_id" id="character_id" onchange="this.form.submit()">
                            <option value="" disabled {{ 'selected' if not active_character_id }}>-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ --</option>
                            {% for char_id, char_data in all_characters.items() %}
                            <option value="{{ char_id }}" {{ 'selected' if char_id == active_character_id }}>{{ char_data.name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
                <div class="character-creator">
                    <form action="{{ url_for('create_character') }}" method="POST">
                        <input type="hidden" name="chat_id" value="{{ chat_id }}">
                        <input type="text" name="new_character_name" placeholder="–ò–º—è –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" required>
                        <button type="submit" class="button-success">‚ú® –°–æ–∑–¥–∞—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>

        {% if active_character_id and active_character_data %}
        <div class="character-editor-section">
            <h4>2. –†–µ–¥–∞–∫—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: "{{ active_character_data.name }}"</h4>
            <form action="{{ url_for('save_character', character_id=active_character_id, chat_id=chat_id) }}" method="POST" id="character-data-form">
                <div class="form-group"><label>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label><input type="text" name="character_name" value="{{ active_character_data.name }}"></div>
                <div class="form-group"><label>üë§ –õ–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label><textarea name="personality_prompt" class="prompt-field personality-field" rows="5">{{ active_character_data.personality_prompt }}</textarea></div>
                <div class="form-group">
                    <label>üí¨ –ö–æ–Ω—Ç–µ–∫—Å—Ç —ç—Ç–æ–≥–æ —á–∞—Ç–∞ (–¥–ª—è AI):</label>
                    <textarea name="chat_context_prompt" class="prompt-field context-field" rows="4">{{ chat_settings.get('chat_context_prompt', '') }}</textarea>
                </div>
                <div class="form-group"><label>üß† –ü–∞–º—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):</label><textarea name="memory_prompt" class="prompt-field memory-field" rows="6">{{ active_character_data.memory_prompt }}</textarea></div>
                <div class="form-group"><label>üõ†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</label><textarea name="system_commands_prompt" class="prompt-field system-field" rows="4">{{ active_character_data.system_commands_prompt }}</textarea></div>
                <div class="form-group"><label>‚öôÔ∏è –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏:</label><textarea name="memory_update_prompt" class="prompt-field memory-update-field" rows="5">{{ active_character_data.memory_update_prompt }}</textarea></div>
                <button type="submit" class="button-save-character">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            </form>
        </div>

        <div class="character-actions-section">
            <h4>3. –î–µ–π—Å—Ç–≤–∏—è –≤ —á–∞—Ç–µ</h4>
            <div class="character-actions">
                
                <form action="{{ url_for('generate_reply', chat_id=chat_id) }}" method="post" id="generate-form-character">
                    <input type="hidden" name="history_limit" value="{{ current_limit }}">
                    <div class="form-group">
                        <label for="model_name_char">ü§ñ –ú–æ–¥–µ–ª—å Gemini –¥–ª—è –æ—Ç–≤–µ—Ç–∞:</label>
                        <input type="text" name="model_name" id="model_name_char" value="{{ active_character_data.advanced_settings.get('model_name') or default_model_name }}" required>
                    </div>
                    
                    <button type="submit" class="generate-button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç <span class="loading-spinner"></span></button>
                </form>
                <form action="{{ url_for('update_memory_route', chat_id=chat_id) }}" method="POST">
                     <button type="submit" class="button-secondary" onclick="return confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–∏—Ç –∏—Ö —Å—É—Ç—å –≤ –ø–∞–º—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');">‚úçÔ∏è –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–º—è—Ç—å</button>
                </form>
            </div>
        </div>
        
        {% else %}
            <p class="settings-description" style="text-align: center; margin-top: 20px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</p>
        {% endif %}
    </div>
</div>

<div class="content-card">
    <div class="sticker-controls">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–∫–µ—Ä–∞–º–∏</h3>
        <p class="settings-description">
            –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã <strong>–¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</strong>.
        </p>
        <form action="{{ url_for('update_sticker_status', chat_id=chat_id) }}" method="post">
            <details class="sticker-dropdown">
                <summary>–í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤</summary>
                <div class="sticker-list">
                    {% if sticker_packs %}
                        {% for pack in sticker_packs %}
                        <label class="sticker-item">
                            <input type="checkbox" name="sticker_enabled" value="{{ pack.codename }}" 
                                   {{ 'checked' if active_character_data and pack.codename in active_character_data.enabled_sticker_packs }}>
                            <span>{{ pack.codename }}</span>
                        </label>
                        {% endfor %}
                    {% else %}
                        <p>–ù–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                    {% endif %}
                </div>
            </details>
            <div class="sticker-buttons">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã</button>
                <button type="button" id="copy-sticker-prompt-btn" data-sticker-prompt="{{ sticker_prompt_text_for_js }}">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç</button>
            </div>
        </form>
    </div>
</div>

<div class="content-card">
    <details class="advanced-settings-details">
        <summary><span class="summary-title"><span class="summary-icon">‚öôÔ∏è</span> –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ</span></summary>
        <div class="settings-content-wrapper">
             <p class="settings-description">
                –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ <strong>"{{ active_character_data.name if active_character_data else '...'}}"</strong> —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º —á–∞—Ç–µ.
                <br>–û–Ω–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
            </p>
            <form action="{{ url_for('save_chat_settings_route', chat_id=chat_id) }}" method="post" id="advanced-settings-form">
                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞</h4>
                <p class="settings-description" style="font-size: 0.9em; text-align: left; padding-bottom: 10px; margin-bottom: 15px; border-bottom: none;">
                    –û—Ç–∫–ª—é—á–∏—Ç–µ –≥–∞–ª–æ—á–∫–∏, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–æ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–ª–∞—Å—å —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]").
                    –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —ç–∫–æ–Ω–æ–º–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏ –∏–∑–±–µ–≥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–Ω—É–∂–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_photos" id="can_see_photos" value="true" {% if chat_settings.get('can_see_photos', True) %}checked{% endif %}>
                            –ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ñ–æ—Ç–æ
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_videos" id="can_see_videos" value="true" {% if chat_settings.get('can_see_videos', True) %}checked{% endif %}>
                             –ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤–∏–¥–µ–æ –∏ –∫—Ä—É–∂–æ—á–∫–∏
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_audio" id="can_see_audio" value="true" {% if chat_settings.get('can_see_audio', True) %}checked{% endif %}>
                            –ú–æ–∂–µ—Ç "—Å–ª—ã—à–∞—Ç—å" –∞—É–¥–∏–æ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_files_pdf" id="can_see_files_pdf" value="true" {% if chat_settings.get('can_see_files_pdf', True) %}checked{% endif %}>
                            –ú–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª—ã (PDF)
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="ignore_all_media" value="true" {% if chat_settings.get('ignore_all_media', False) %}checked{% endif %}>
                            –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –º–µ–¥–∏–∞ (–ø—É—Å—Ç–æ—Ç–∞)
                        </label>
                        <small>–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ –∏ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –ø—É—Å—Ç–æ—Ç—É, –∞ –Ω–µ –Ω–∞ –∑–∞–≥–ª—É—à–∫—É "[–ú–µ–¥–∏–∞]".</small>
                    </div>
                </div>
                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–º—è—Ç–∏</h4>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="enable_auto_memory" value="true" {% if chat_settings.get('enable_auto_memory', True) %}checked{% endif %}>
                        –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
                    </label>
                    <small>–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –ø–∞–º—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º–µ.</small>
                </div>
                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ê–≤—Ç–æ-—Ä–µ–∂–∏–º–∞</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="auto_mode_check_interval">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫)</label>
                        <input type="number" step="0.1" name="auto_mode_check_interval" id="auto_mode_check_interval" value="{{ chat_settings.auto_mode_check_interval }}" required>
                        <small>–ö–∞–∫ —á–∞—Å—Ç–æ –±–æ—Ç –∏—â–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.</small>
                    </div>
                    <div class="form-group">
                        <label for="auto_mode_initial_wait">–ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ (—Å–µ–∫)</label>
                        <input type="number" step="0.1" name="auto_mode_initial_wait" id="auto_mode_initial_wait" value="{{ chat_settings.auto_mode_initial_wait }}" required>
                        <small>–°–∫–æ–ª—å–∫–æ –∂–¥–∞—Ç—å, –¥–∞–≤–∞—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –¥–æ–ø–∏—Å–∞—Ç—å.</small>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="auto_mode_no_reply_timeout">–¢–∞–π–º–∞—É—Ç –º–æ–ª—á–∞–Ω–∏—è (–º–∏–Ω)</label>
                    <input type="number" step="0.1" name="auto_mode_no_reply_timeout" id="auto_mode_no_reply_timeout" value="{{ chat_settings.auto_mode_no_reply_timeout }}" required>
                    <small>–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –º–æ–ª—á–∞–Ω–∏—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É.</small>
                </div>
                <div class="form-group">
                    <label for="auto_mode_no_reply_suffix">–ü—Ä–æ–º–ø—Ç –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–µ–±–µ</label>
                    <textarea name="auto_mode_no_reply_suffix" id="auto_mode_no_reply_suffix" rows="2">{{ chat_settings.auto_mode_no_reply_suffix }}</textarea>
                    <small>–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –ø—Ä–æ–º–ø—Ç—É –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞.</small>
                </div>

                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Gemini</h4>
                <div class="form-group">
                    <label for="model_name_advanced">–ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
                    <input type="text" name="model_name_advanced" id="model_name_advanced" value="{{ chat_settings.get('model_name', '') }}">
                    <small>–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —ç—Ç–∞ –º–æ–¥–µ–ª—å. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞.</small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="enable_google_search" value="true" {% if chat_settings.get('enable_google_search') %}checked{% endif %}>
                            –í–∫–ª—é—á–∏—Ç—å –ø–æ–∏—Å–∫ Google
                        </label>
                        <small>–†–∞–∑—Ä–µ—à–∞–µ—Ç –º–æ–¥–µ–ª–∏ –∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ Google.</small>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="enable_thinking" value="true" {% if chat_settings.get('enable_thinking') %}checked{% endif %}>
                            –í–∫–ª—é—á–∏—Ç—å "–†–∞–∑–º—ã—à–ª–µ–Ω–∏–µ" (Thinking)
                        </label>
                        <small>–î–ª—è –º–æ–¥–µ–ª–µ–π 2.5 Pro/Flash. –£–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤.</small>
                    </div>
                </div>

                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h4>
                 <div class="form-group">
                    <label for="num_messages_to_fetch">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</label>
                    <input type="number" name="num_messages_to_fetch" id="num_messages_to_fetch" value="{{ chat_settings.num_messages_to_fetch }}" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sticker_choosing_delay_min">–ú–∏–Ω. –ø–∞—É–∑–∞ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ (—Å)</label>
                        <input type="number" step="0.1" name="sticker_choosing_delay_min" id="sticker_choosing_delay_min" value="{{ chat_settings.sticker_choosing_delay_min }}" required>
                    </div>
                    <div class="form-group">
                        <label for="sticker_choosing_delay_max">–ú–∞–∫—Å. –ø–∞—É–∑–∞ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ (—Å)</label>
                        <input type="number" step="0.1" name="sticker_choosing_delay_max" id="sticker_choosing_delay_max" value="{{ chat_settings.sticker_choosing_delay_max }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="base_thinking_delay_s_min">–ú–∏–Ω. –ø–∞—É–∑–∞ –¥–æ –ø–µ—á–∞—Ç–∏ (—Å)</label>
                        <input type="number" step="0.1" name="base_thinking_delay_s_min" id="base_thinking_delay_s_min" value="{{ chat_settings.base_thinking_delay_s_min }}" required>
                    </div>
                    <div class="form-group">
                        <label for="base_thinking_delay_s_max">–ú–∞–∫—Å. –ø–∞—É–∑–∞ –¥–æ –ø–µ—á–∞—Ç–∏ (—Å)</label>
                        <input type="number" step="0.1" name="base_thinking_delay_s_max" id="base_thinking_delay_s_max" value="{{ chat_settings.base_thinking_delay_s_max }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="typing_delay_ms_min">–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ (–º—Å/—Å–∏–º–≤)</label>
                        <input type="number" step="1" name="typing_delay_ms_min" id="typing_delay_ms_min" value="{{ chat_settings.typing_delay_ms_min }}" required>
                        <small>–û—Ç (–º–µ–Ω—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ)</small>
                    </div>
                    <div class="form-group">
                        <label for="typing_delay_ms_max">–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ (–º—Å/—Å–∏–º–≤)</label>
                        <input type="number" step="1" name="typing_delay_ms_max" id="typing_delay_ms_max" value="{{ chat_settings.typing_delay_ms_max }}" required>
                        <small>–î–æ (–±–æ–ª—å—à–µ = –º–µ–¥–ª–µ–Ω–Ω–µ–µ)</small>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="max_typing_duration_s">–ú–∞–∫—Å. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ (—Å–µ–∫)</label>
                    <input type="number" step="0.5" name="max_typing_duration_s" id="max_typing_duration_s" value="{{ chat_settings.max_typing_duration_s }}" required>
                    <small>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–∏–º—É–ª—è—Ü–∏—è –Ω–µ –¥–ª–∏–ª–∞—Å—å –≤–µ—á–Ω–æ.</small>
                </div>
                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–ø–µ—á–∞—Ç–æ–∫</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="substitution_chance">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–º–µ–Ω—ã —Å–∏–º–≤–æ–ª–∞</label>
                        <input type="number" step="0.0001" min="0" max="1" name="substitution_chance" id="substitution_chance" value="{{ chat_settings.get('substitution_chance', 0.005) }}" required>
                        <small>–®–∞–Ω—Å –∑–∞–º–µ–Ω—ã –±—É–∫–≤—ã –Ω–∞ —Å–æ—Å–µ–¥–Ω—é—é. –î–µ—Ñ–æ–ª—Ç: 0.005</small>
                    </div>
                    <div class="form-group">
                        <label for="transposition_chance">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
                        <input type="number" step="0.0001" min="0" max="1" name="transposition_chance" id="transposition_chance" value="{{ chat_settings.get('transposition_chance', 0.005) }}" required>
                        <small>–®–∞–Ω—Å –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–≤—É—Ö —Å–æ—Å–µ–¥–Ω–∏—Ö –±—É–∫–≤. –î–µ—Ñ–æ–ª—Ç: 0.005</small>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="skip_chance">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–∞ —Å–∏–º–≤–æ–ª–∞</label>
                    <input type="number" step="0.0001" min="0" max="1" name="skip_chance" id="skip_chance" value="{{ chat_settings.get('skip_chance', 0.002) }}" required>
                    <small>–®–∞–Ω—Å —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –±—É–∫–≤—ã –∏–ª–∏ —Ü–∏—Ñ—Ä—ã. –î–µ—Ñ–æ–ª—Ç: 0.002</small>
                </div>
                <div class="form-group">
                    <label for="lower_chance">–®–∞–Ω—Å —Å—Ç—Ä–æ—á–Ω–æ–π –±—É–∫–≤—ã –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏</label>
                    <input type="number" step="0.01" min="0" max="1" name="lower_chance" id="lower_chance" value="{{ chat_settings.get('lower_chance', 0.01) }}" required>
                    <small>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å "–∑–∞–±—ã—Ç—å" Shift –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏. –î–µ—Ñ–æ–ª—Ç: 0.01</small>
                </div>
                
                <div class="settings-actions">
                    <button type="submit"
                            formaction="{{ url_for('reset_chat_settings_route', chat_id=chat_id) }}"
                            formmethod="post"
                            class="button-secondary"
                            onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ –∫ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?');"
                            style="margin-right: auto;">–°–±—Ä–æ—Å–∏—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞</button>
                    <button type="submit" name="save_action" value="save_for_chat_and_default" class="button-secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è —á–∞—Ç–∞ –∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                    <button type="submit" name="save_action" value="save_for_chat" form="advanced-settings-form">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞</button>
                </div>
            </form>
        </div>
    </details>
</div>


<div class="content-card">
    <h2>–ê–≤—Ç–æ-—Ä–µ–∂–∏–º</h2>
    <div class="auto-mode-controls">
        {% if auto_mode_status == 'active' %}
            <p style="color: var(--success-text); font-weight: 600;">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º <strong>–∞–∫—Ç–∏–≤–µ–Ω</strong>.</p>
            <form action="{{ url_for('stop_auto_mode', chat_id=chat_id) }}" method="post" style="display: inline;">
                <button type="submit">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º</button>
            </form>
        {% elif auto_mode_status == 'stopping' %}
            <p style="color: var(--warning-text); font-weight: 600;">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º <strong>–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...</strong></p>
            <button type="button" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º</button>
        {% else %}
             <p>–ê–≤—Ç–æ-—Ä–µ–∂–∏–º <strong>–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</strong>.</p>
             <form action="{{ url_for('start_auto_mode', chat_id=chat_id) }}" method="post" style="display: inline;">
                 <button type="submit" style="background-color: #4CAF50; color: white;">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º</button>
             </form>
        {% endif %}
    </div>
    <small style="display: block; margin-top: 10px;">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.</small>
</div>


<div id="generated-reply-container" class="content-card generated-reply-section" style="display: none;"> <!-- –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç -->
    <h2>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:</h2>
    <form action="{{ url_for('send_reply', chat_id=chat_id) }}" method="post">
        <div class="form-group">
            <textarea name="message_to_send" id="generated-reply-textarea" rows="6" required></textarea> <!-- –î–æ–±–∞–≤–ª–µ–Ω ID -->
        </div>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
    </form>
</div>

<div class="back-link-container"> 
    <a href="{{ url_for('index') }}">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —á–∞—Ç–∞</a> 
</div>

<script>
    function handleAjaxGeneration() {
        const generateForm = document.getElementById('generate-form-character');
        if (!generateForm) return;

        const generateButton = generateForm.querySelector('.generate-button');
        const spinner = generateButton.querySelector('.loading-spinner');
        const replyContainer = document.getElementById('generated-reply-container');
        const replyTextarea = document.getElementById('generated-reply-textarea');

        generateForm.addEventListener('submit', function(event) {
            
            event.preventDefault();

            
            generateButton.disabled = true;
            spinner.style.display = 'inline-block';
            replyContainer.style.display = 'none'; 
            replyTextarea.value = '';
            
            
            const oldError = document.getElementById('generation-error-dynamic');
            if (oldError) oldError.remove();

            
            fetch(generateForm.action, {
                method: 'POST',
                body: new FormData(generateForm)
            })
            .then(response => {
                if (!response.ok) {
                    
                    return response.json().then(errData => {
                        throw new Error(errData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.statusText}`);
                    });
                }
                return response.json(); 
            })
            .then(data => {
                
                if (data.status === 'success') {
                    replyTextarea.value = data.reply;
                    replyContainer.style.display = 'block'; 
                } else {
                    
                    throw new Error(data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
                }
            })
            .catch(error => {
                
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-error';
                errorDiv.id = 'generation-error-dynamic';
                errorDiv.textContent = error.message;
                generateForm.insertAdjacentElement('afterend', errorDiv);
            })
            .finally(() => {
             
                generateButton.disabled = false;
                spinner.style.display = 'none';
            });
        });
    }
    function handleStickerCopy() {
        const copyBtn = document.getElementById('copy-sticker-prompt-btn');
        if (!copyBtn) return;

        const stickerPromptText = copyBtn.dataset.stickerPrompt;
        
        if (!stickerPromptText || stickerPromptText.trim() === '') {
            copyBtn.disabled = true;
            copyBtn.title = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞";
            return; 
        }
        
        copyBtn.addEventListener('click', () => {
             navigator.clipboard.writeText(stickerPromptText).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                copyBtn.disabled = true;
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚ùå –û—à–∏–±–∫–∞!';
                copyBtn.disabled = true;
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.disabled = false;
                }, 2500);
            });
        });
    }
    
    function setupLoadingSpinners() {
        const generateButtons = document.querySelectorAll('.generate-button');
        
        generateButtons.forEach(button => {
            const form = button.closest('form');
            if (form) {
                form.addEventListener('submit', function() {
                    button.disabled = true;
                });
            }
        });
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        handleStickerCopy();
        setupLoadingSpinners();
        handleAjaxGeneration();
    });

    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            const generateButtons = document.querySelectorAll('.generate-button');
            generateButtons.forEach(button => {
                if (button.disabled) {
                    button.disabled = false;
                }
            });
        }
    });
</script>

{% endblock %}