
{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å {{ chat_info.name if chat_info else '...' }}{% endblock %}

{% block content %}

<div class="content-card"> 
    <h1>–ß–∞—Ç —Å {{ chat_info.name if chat_info else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —á–∞—Ç' }}</h1>
    <p class="chat-id-display"><small>ID —á–∞—Ç–∞: {{ chat_id }}</small></p>

    {% if history_error %}
         
    {% endif %}

    
    <div class="update-history-form">
        <form method="get" action="{{ url_for('chat_page', chat_id=chat_id) }}">
             <label for="num_messages_to_load">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π:</label>
             <input type="number" name="limit" id="num_messages_to_load" value="{{ current_limit }}" min="1" max="500">
             <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>
    </div>

    <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ({{ '–ü–æ—Å–ª–µ–¥–Ω–∏–µ ' ~ history | length if history else '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π' }})</h2>
    <div class="chat-history">
        {% if history %}
            {% for msg in history %}
                <div class="message {{ msg.role }}">
                    
                    {% for part in msg.parts %}
                        {% if part.text %}
                            <pre>{{ part.text }}</pre>
                        {% endif %}

                        
                        {% if part.image_base64 %}
                            <img src="data:{{ part.mime_type }};base64,{{ part.image_base64 }}"
                                alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞"
                                style="max-width: 100%; border-radius: 12px; margin-top: 8px;">
                        
                        
                        {% elif part.video_base64 and part.mime_type == 'video/mp4' %}
                            <video controls loop autoplay muted
                                style="max-width: 100%; border-radius: 12px; margin-top: 8px;">
                                <source src="data:{{ part.mime_type }};base64,{{ part.video_base64 }}" type="{{ part.mime_type }}">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—ç–≥ video.
                            </video>
                        
                        {% elif part.audio_base64 and part.mime_type in ['audio/mpeg', 'audio/ogg'] %}
                        
                             <audio controls>
                                 <source src="data:{{ part.mime_type }};base64,{{ part.audio_base64 }}" type="{{ part.mime_type }}">
                                 –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç.
                             </audio>
                        {% elif part.file_base64 and part.mime_type == 'application/pdf' %}
                             <a href="data:{{ part.mime_type }};base64,{{ part.file_base64 }}" target="_blank" class="pdf-attachment">
                                 <span class="pdf-icon">üìÑ</span>
                                 <div class="pdf-info">
                                     <strong>PDF –î–æ–∫—É–º–µ–Ω—Ç</strong>
                                     <small>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</small>
                                 </div>
                             </a>
                        {% endif %}
                        

                    {% endfor %}
                    
                </div>
            {% endfor %}
        {% else %}
            {% if not history_error %}
            <p style="text-align: center; color: var(--secondary-color); padding: 20px;">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç–∞.</p>
            {% endif %}
        {% endif %}
    </div>
</div>


<div class="content-card">
    <div class="generation-header">
        <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞</h2>
        <form action="{{ url_for('set_generation_mode', chat_id=chat_id) }}" method="POST" class="mode-switcher-form">
            <button type="submit" name="mode" value="prompt" class="switch-button {{ 'active' if generation_mode == 'prompt' }}">
                –†–µ–∂–∏–º –ü—Ä–æ–º–ø—Ç–∞
            </button>
            <button type="submit" name="mode" value="character" class="switch-button {{ 'active' if generation_mode == 'character' }}">
                –†–µ–∂–∏–º –ü–µ—Ä—Å–æ–Ω–∞–∂–∞
            </button>
        </form>
    </div>

    {% if generation_error %}
        <div class="alert alert-error">{{ generation_error }}</div>
    {% endif %}

    <!-- ======================= –†–ï–ñ–ò–ú "–ü–†–û–ú–ü–¢" ======================= -->
    <div id="prompt-mode-view" style="display: {{ 'block' if generation_mode == 'prompt' else 'none' }};">
        <p class="settings-description">–í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–≤–æ–π –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç. –ü—Ä–æ—Å—Ç–æ –∏ –±—ã—Å—Ç—Ä–æ.</p>
        <form action="{{ url_for('generate_reply', chat_id=chat_id) }}" method="post" id="generate-form-prompt">
            <input type="hidden" name="history_limit" value="{{ current_limit }}">
            <div class="form-group">
                <label for="system_prompt">üìù –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ò–ò):</label>
                <textarea name="system_prompt" id="system_prompt" rows="6">{{ loaded_system_prompt }}</textarea>
                <small>–ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç", —á—Ç–æ–±—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å –µ–≥–æ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞.</small>
            </div>
            <div class="form-group">
                <label for="model_name_prompt">ü§ñ –ú–æ–¥–µ–ª—å Gemini:</label>
                <input type="text" name="model_name" id="model_name_prompt" value="{{ default_model_name }}" required>
            </div>
            <div class="form-actions">
                 <button type="submit" class="generate-button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                 <form action="{{ url_for('save_prompt', chat_id=chat_id) }}" method="post" class="inline-form">
                     <input type="hidden" name="prompt_to_save" id="prompt_to_save_hidden">
                     <button type="button" class="button-secondary" onclick="document.getElementById('prompt_to_save_hidden').value = document.getElementById('system_prompt').value; this.form.submit();">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç</button>
                </form>
            </div>
        </form> 
    </div>

    <!-- ======================= –†–ï–ñ–ò–ú "–ü–ï–†–°–û–ù–ê–ñ" ======================= -->
    <div id="character-mode-view" style="display: {{ 'block' if generation_mode == 'character' else 'none' }};">
        <div class="character-management-section">
            <h4>1. –í—ã–±–æ—Ä –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h4>
            <div class="character-management">
                <div class="character-selector">
                    <form action="{{ url_for('set_active_character', chat_id=chat_id) }}" method="POST" id="character-select-form">
                        <label for="character_id">–ê–∫—Ç–∏–≤–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂:</label>
                        <select name="character_id" id="character_id" onchange="this.form.submit()">
                            <option value="" disabled {{ 'selected' if not active_character_id }}>-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ --</option>
                            {% for char_id, char_data in all_characters.items() %}
                            <option value="{{ char_id }}" {{ 'selected' if char_id == active_character_id }}>{{ char_data.name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
                <div class="character-creator">
                    <form action="{{ url_for('create_character') }}" method="POST">
                        <input type="text" name="new_character_name" placeholder="–ò–º—è –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" required>
                        <button type="submit" class="button-success">‚ú® –°–æ–∑–¥–∞—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>

        {% if active_character_id and active_character_data %}
        <div class="character-editor-section">
            <h4>2. –†–µ–¥–∞–∫—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: "{{ active_character_data.name }}"</h4>
            <form action="{{ url_for('save_character', character_id=active_character_id) }}" method="POST" id="character-data-form">
                <div class="form-group"><label>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label><input type="text" name="character_name" value="{{ active_character_data.name }}"></div>
                <div class="form-group"><label>üë§ –õ–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label><textarea name="personality_prompt" class="prompt-field personality-field" rows="5">{{ active_character_data.personality_prompt }}</textarea></div>
                <div class="form-group"><label>üß† –ü–∞–º—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):</label><textarea name="memory_prompt" class="prompt-field memory-field" rows="6">{{ active_character_data.memory_prompt }}</textarea></div>
                <div class="form-group"><label>üõ†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</label><textarea name="system_commands_prompt" class="prompt-field system-field" rows="4">{{ active_character_data.system_commands_prompt }}</textarea></div>
                <div class="form-group"><label>‚öôÔ∏è –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏:</label><textarea name="memory_update_prompt" class="prompt-field memory-update-field" rows="5">{{ active_character_data.memory_update_prompt }}</textarea></div>
                <button type="submit" class="button-save-character">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            </form>
        </div>

        <div class="character-actions-section">
            <h4>3. –î–µ–π—Å—Ç–≤–∏—è –≤ —á–∞—Ç–µ</h4>
            <div class="character-actions">
                <form action="{{ url_for('generate_reply', chat_id=chat_id) }}" method="post" id="generate-form-character">
                    <input type="hidden" name="history_limit" value="{{ current_limit }}">
                    <div class="form-group"><label for="model_name_char">ü§ñ –ú–æ–¥–µ–ª—å Gemini –¥–ª—è –æ—Ç–≤–µ—Ç–∞:</label><input type="text" name="model_name" id="model_name_char" value="{{ default_model_name }}" required></div>
                    <button type="submit" class="generate-button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                </form>
                <form action="{{ url_for('update_memory_route', chat_id=chat_id) }}" method="POST">
                     <button type="submit" class="button-secondary" onclick="return confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–∏—Ç –∏—Ö —Å—É—Ç—å –≤ –ø–∞–º—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');">‚úçÔ∏è –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–º—è—Ç—å</button>
                </form>
            </div>
        </div>
        
        {% else %}
            <p class="centered-message">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</p>
        {% endif %}
    </div>
</div>

<!-- =================================================================== -->
<!-- ==== –ë–õ–û–ö–ò –°–¢–ò–ö–ï–†–û–í –ò –ù–ê–°–¢–†–û–ï–ö  =================================== -->
<!-- =================================================================== -->
<div class="content-card">
    <div class="sticker-controls">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–∫–µ—Ä–∞–º–∏</h3>
        <p class="settings-description">
            {% if generation_mode == 'character' %}
            –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã <strong>–¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</strong>.
            {% else %}
            –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã <strong>–≥–ª–æ–±–∞–ª—å–Ω–æ</strong> (–¥–ª—è —Ä–µ–∂–∏–º–∞ "–ü—Ä–æ–º–ø—Ç").
            {% endif %}
        </p>
        <form action="{{ url_for('update_sticker_status', chat_id=chat_id) }}" method="post">
            <details class="sticker-dropdown">
                <summary>–í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤</summary>
                <div class="sticker-list">
                    {% if sticker_packs %}
                        {% for pack in sticker_packs %}
                        <label class="sticker-item">
                            {% set is_checked = (pack.codename in active_character_data.enabled_sticker_packs) if generation_mode == 'character' else pack.enabled %}
                            <input type="checkbox" name="sticker_enabled" value="{{ pack.codename }}" {{ 'checked' if is_checked }}>
                            <span>{{ pack.codename }}</span>
                        </label>
                        {% endfor %}
                    {% else %}
                        <p>–ù–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                    {% endif %}
                </div>
            </details>
            <div class="sticker-buttons">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã</button>
                <button type="button" id="copy-sticker-prompt-btn" data-sticker-prompt="{{ sticker_prompt_text_for_js }}">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç</button>
            </div>
        </form>
    </div>
</div>

<div class="content-card">
    <details class="advanced-settings-details">
        <summary><span class="summary-title"><span class="summary-icon">‚öôÔ∏è</span> –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</span></summary>
        <div class="settings-content-wrapper">
             <p class="settings-description">
                {% if generation_mode == 'character' %}
                –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã <strong>–¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</strong>.
                {% else %}
                –≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã <strong>–¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞</strong> –≤ —Ä–µ–∂–∏–º–µ "–ü—Ä–æ–º–ø—Ç".
                {% endif %}
            </p>
            <form action="{{ url_for('save_chat_settings_route', chat_id=chat_id) }}" method="post" id="advanced-settings-form">
                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞</h4>
                <p class="settings-description" style="font-size: 0.9em; text-align: left; padding-bottom: 10px; margin-bottom: 15px; border-bottom: none;">
                    –û—Ç–∫–ª—é—á–∏—Ç–µ –≥–∞–ª–æ—á–∫–∏, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–æ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–ª–∞—Å—å —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]").
                    –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —ç–∫–æ–Ω–æ–º–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏ –∏–∑–±–µ–≥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–Ω—É–∂–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_photos" id="can_see_photos" value="true" {% if chat_settings.get('can_see_photos', True) %}checked{% endif %}>
                            –ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ñ–æ—Ç–æ
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_videos" id="can_see_videos" value="true" {% if chat_settings.get('can_see_videos', True) %}checked{% endif %}>
                             –ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤–∏–¥–µ–æ –∏ –∫—Ä—É–∂–æ—á–∫–∏
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_audio" id="can_see_audio" value="true" {% if chat_settings.get('can_see_audio', True) %}checked{% endif %}>
                            –ú–æ–∂–µ—Ç "—Å–ª—ã—à–∞—Ç—å" –∞—É–¥–∏–æ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="can_see_files_pdf" id="can_see_files_pdf" value="true" {% if chat_settings.get('can_see_files_pdf', True) %}checked{% endif %}>
                            –ú–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª—ã (PDF)
                        </label>
                    </div>
                </div>
                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ê–≤—Ç–æ-—Ä–µ–∂–∏–º–∞</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="auto_mode_check_interval">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–µ–∫)</label>
                        <input type="number" step="0.1" name="auto_mode_check_interval" id="auto_mode_check_interval" value="{{ chat_settings.auto_mode_check_interval }}" required>
                        <small>–ö–∞–∫ —á–∞—Å—Ç–æ –±–æ—Ç –∏—â–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.</small>
                    </div>
                    <div class="form-group">
                        <label for="auto_mode_initial_wait">–ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ (—Å–µ–∫)</label>
                        <input type="number" step="0.1" name="auto_mode_initial_wait" id="auto_mode_initial_wait" value="{{ chat_settings.auto_mode_initial_wait }}" required>
                        <small>–°–∫–æ–ª—å–∫–æ –∂–¥–∞—Ç—å, –¥–∞–≤–∞—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –¥–æ–ø–∏—Å–∞—Ç—å.</small>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="auto_mode_no_reply_timeout">–¢–∞–π–º–∞—É—Ç –º–æ–ª—á–∞–Ω–∏—è (–º–∏–Ω)</label>
                    <input type="number" step="0.1" name="auto_mode_no_reply_timeout" id="auto_mode_no_reply_timeout" value="{{ chat_settings.auto_mode_no_reply_timeout }}" required>
                    <small>–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –º–æ–ª—á–∞–Ω–∏—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É.</small>
                </div>
                <div class="form-group">
                    <label for="auto_mode_no_reply_suffix">–ü—Ä–æ–º–ø—Ç –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–µ–±–µ</label>
                    <textarea name="auto_mode_no_reply_suffix" id="auto_mode_no_reply_suffix" rows="2">{{ chat_settings.auto_mode_no_reply_suffix }}</textarea>
                    <small>–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –ø—Ä–æ–º–ø—Ç—É –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞.</small>
                </div>

                <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h4>
                 <div class="form-group">
                    <label for="num_messages_to_fetch">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</label>
                    <input type="number" name="num_messages_to_fetch" id="num_messages_to_fetch" value="{{ chat_settings.num_messages_to_fetch }}" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sticker_choosing_delay_min">–ú–∏–Ω. –ø–∞—É–∑–∞ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ (—Å)</label>
                        <input type="number" step="0.1" name="sticker_choosing_delay_min" id="sticker_choosing_delay_min" value="{{ chat_settings.sticker_choosing_delay_min }}" required>
                    </div>
                    <div class="form-group">
                        <label for="sticker_choosing_delay_max">–ú–∞–∫—Å. –ø–∞—É–∑–∞ –¥–ª—è —Å—Ç–∏–∫–µ—Ä–∞ (—Å)</label>
                        <input type="number" step="0.1" name="sticker_choosing_delay_max" id="sticker_choosing_delay_max" value="{{ chat_settings.sticker_choosing_delay_max }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="base_thinking_delay_s_min">–ú–∏–Ω. –ø–∞—É–∑–∞ –¥–æ –ø–µ—á–∞—Ç–∏ (—Å)</label>
                        <input type="number" step="0.1" name="base_thinking_delay_s_min" id="base_thinking_delay_s_min" value="{{ chat_settings.base_thinking_delay_s_min }}" required>
                    </div>
                    <div class="form-group">
                        <label for="base_thinking_delay_s_max">–ú–∞–∫—Å. –ø–∞—É–∑–∞ –¥–æ –ø–µ—á–∞—Ç–∏ (—Å)</label>
                        <input type="number" step="0.1" name="base_thinking_delay_s_max" id="base_thinking_delay_s_max" value="{{ chat_settings.base_thinking_delay_s_max }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="typing_delay_ms_min">–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ (–º—Å/—Å–∏–º–≤)</label>
                        <input type="number" step="1" name="typing_delay_ms_min" id="typing_delay_ms_min" value="{{ chat_settings.typing_delay_ms_min }}" required>
                        <small>–û—Ç (–º–µ–Ω—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ)</small>
                    </div>
                    <div class="form-group">
                        <label for="typing_delay_ms_max">–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ (–º—Å/—Å–∏–º–≤)</label>
                        <input type="number" step="1" name="typing_delay_ms_max" id="typing_delay_ms_max" value="{{ chat_settings.typing_delay_ms_max }}" required>
                        <small>–î–æ (–±–æ–ª—å—à–µ = –º–µ–¥–ª–µ–Ω–Ω–µ–µ)</small>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="max_typing_duration_s">–ú–∞–∫—Å. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ (—Å–µ–∫)</label>
                    <input type="number" step="0.5" name="max_typing_duration_s" id="max_typing_duration_s" value="{{ chat_settings.max_typing_duration_s }}" required>
                    <small>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–∏–º—É–ª—è—Ü–∏—è –Ω–µ –¥–ª–∏–ª–∞—Å—å –≤–µ—á–Ω–æ.</small>
                </div>
                
                <!-- –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫, —á—Ç–æ–±—ã –≤—ã—Ä–æ–≤–Ω—è—Ç—å –∏—Ö —Å–ø—Ä–∞–≤–∞ -->
                <div class="settings-actions">
                    <form action="{{ url_for('reset_chat_settings_route', chat_id=chat_id) }}" method="post" class="reset-form">
                        <button type="submit" class="button-secondary" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?');">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    </form>
                    <button type="submit" form="advanced-settings-form">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </details>
</div>


<div class="content-card">
    <h2>–ê–≤—Ç–æ-—Ä–µ–∂–∏–º</h2>
    <div class="auto-mode-controls">
        {% if auto_mode_status == 'active' %}
            <p style="color: var(--success-color); font-weight: 500;">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º <strong>–∞–∫—Ç–∏–≤–µ–Ω</strong>.</p>
            <form action="{{ url_for('stop_auto_mode', chat_id=chat_id) }}" method="post" style="display: inline;">
                <button type="submit" class="button-danger">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º</button>
            </form>
        {% elif auto_mode_status == 'stopping' %}
            <p style="color: var(--warning-color); font-weight: 500;">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º <strong>–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...</strong></p>
            <button type="button" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º</button> {# –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≤–æ –≤—Ä–µ–º—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ #}
        {% else %} {# inactive or None #}
             <p style="color: var(--secondary-color);">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º <strong>–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</strong>.</p>
             <form action="{{ url_for('start_auto_mode', chat_id=chat_id) }}" method="post" style="display: inline;">
                 <button type="submit" class="button-success">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º</button>
             </form>
        {% endif %}
    </div>
    <small style="display: block; margin-top: 10px;">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–¥–∞–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º.</small>
</div>


{% if generated_reply %}
<div class="content-card generated-reply-section">
    <h2>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:</h2>
    <form action="{{ url_for('send_reply', chat_id=chat_id) }}" method="post">
        <div class="form-group">
            <textarea name="message_to_send" rows="6" required>{{ generated_reply }}</textarea>
        </div>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
    </form>
</div> 
{% endif %}

<div class="back-link-container"> 
    <a href="{{ url_for('index') }}">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —á–∞—Ç–∞</a> 
</div>

<script>
    function handleStickerCopy() {
        const copyBtn = document.getElementById('copy-sticker-prompt-btn');
        if (!copyBtn) return;

        const stickerPromptText = copyBtn.dataset.stickerPrompt;

        
        if (!stickerPromptText || stickerPromptText.trim() === '') {
            copyBtn.disabled = true;
            copyBtn.title = "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞";
            return; 
        }
        

        
        copyBtn.addEventListener('click', () => {
             navigator.clipboard.writeText(stickerPromptText).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                copyBtn.disabled = true;
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚ùå –û—à–∏–±–∫–∞!';
                copyBtn.disabled = true;
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.disabled = false;
                }, 2500);
                
            });
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–∏–Ω–Ω–µ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function setupLoadingSpinners() {
        // –ù–∞—Ö–æ–¥–∏–º –í–°–ï –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const generateButtons = document.querySelectorAll('.generate-button');
        
        generateButtons.forEach(button => {
            // –£ –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏ –∏—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Ñ–æ—Ä–º—É
            const form = button.closest('form');
            if (form) {
                form.addEventListener('submit', function() {
                    button.disabled = true;
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–∏–Ω–Ω–µ—Ä —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ HTML
                });
            }
        });
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    document.addEventListener('DOMContentLoaded', (event) => {
        handleStickerCopy();
        setupLoadingSpinners();
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ –∫–µ—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (–∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥")
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            const generateButtons = document.querySelectorAll('.generate-button');
            generateButtons.forEach(button => {
                if (button.disabled) {
                    button.disabled = false;
                }
            });
        }
    });
</script>

{% endblock %}
